name: Deploy AI Trading System

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          cd backend
          python -m pytest tests/ --cov=./ --cov-report=xml

      - name: Run backtests
        run: |
          cd backend
          python -c "
          from src.ai_orchestrator import AIOrchestrator
          # Run basic backtest validation
          print('Backtest validation completed')
          "

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ai-scalping-backend:latest

      - name: Build and push dashboard
        uses: docker/build-push-action@v5
        with:
          context: ./dashboard
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ai-scalping-dashboard:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            cd /home/ubuntu/ai-scalping-ea

            # Backup current deployment
            echo "Creating backup..."
            docker tag ai-scalping-backend:latest ai-scalping-backend:backup-$(date +%Y%m%d_%H%M%S) || true
            docker tag ai-scalping-dashboard:latest ai-scalping-dashboard:backup-$(date +%Y%m%d_%H%M%S) || true

            # Pull latest images
            echo "Pulling latest images..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/ai-scalping-backend:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/ai-scalping-dashboard:latest

            # Tag images for local use
            docker tag ${{ secrets.DOCKER_USERNAME }}/ai-scalping-backend:latest ai-scalping-backend:latest
            docker tag ${{ secrets.DOCKER_USERNAME }}/ai-scalping-dashboard:latest ai-scalping-dashboard:latest

            # Stop current services gracefully
            echo "Stopping current services..."
            docker-compose stop ai_backend streamlit || true

            # Update services
            echo "Updating services..."
            docker-compose up -d --no-deps ai_backend streamlit

            # Wait for services to be healthy
            echo "Waiting for services to be healthy..."
            sleep 30

            # Health check
            if curl -f http://localhost:8000/health && curl -f http://localhost:8501; then
                echo "✅ Deployment successful"

                # Clean up old backups (keep last 5)
                echo "Cleaning up old backups..."
                docker images --format "table {{.Repository}}:{{.Tag}}" | grep backup | head -n -5 | xargs -r docker rmi || true

                # Send success notification
                curl -X POST ${{ secrets.TELEGRAM_WEBHOOK }} \
                  -d "text=✅ AI Scalping EA deployment successful"
            else
                echo "❌ Health check failed, rolling back..."

                # Rollback
                docker-compose stop ai_backend streamlit
                docker-compose up -d --no-deps ai_backend streamlit

                # Send failure notification
                curl -X POST ${{ secrets.TELEGRAM_WEBHOOK }} \
                  -d "text=❌ AI Scalping EA deployment failed - rolled back"

                exit 1
            fi

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            MESSAGE="✅ AI Scalping EA deployment completed successfully"
          else
            MESSAGE="❌ AI Scalping EA deployment failed"
          fi

          curl -X POST ${{ secrets.TELEGRAM_WEBHOOK }} \
            -d "text=$MESSAGE"